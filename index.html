<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Referral Dashboard</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      // ============================
      // üî• Firebase Configuration
      // ============================
      const firebaseConfig = {
        apiKey: "AIzaSyC_SO0ZnItNVoWif48MyMeznuLsA-jq52k",
        authDomain: "tgfjf-9f690.firebaseapp.com",
        databaseURL:    "https://tgfjf-5bbfe-default-rtdb.firebaseio.com",
        projectId: "tgfjf-9f690",
        storageBucket: "tgfjf-9f690.appspot.com",
        messagingSenderId: "431271375984",
        appId: "1:431271375984:web:c206d5a8a3fd7e3286d07a",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ============================
      // üß† User Detection
      // ============================
      let tg = window.Telegram.WebApp;
      let userId =
        tg.initDataUnsafe?.user?.id ||
        new URLSearchParams(window.location.search).get("userId") ||
        null;

      if (!userId) {
        document.getElementById("app").innerHTML =
          "<h3 style='color:red'>‚ö†Ô∏è User not found. Open from Telegram!</h3>";
        throw new Error("User not found");
      }

      console.log("[Dashboard] Checking user:", userId);

      // ============================
      // üì° Fetch User Data
      // ============================
      async function loadUser() {
        const userRef = ref(db, `telegram_users/${userId}`);
        const snap = await get(userRef);

        if (!snap.exists()) {
          document.getElementById("app").innerHTML =
            "<h3>‚ùå User not registered yet</h3>";
          return;
        }

        const user = snap.val();
        document.getElementById("username").innerText = user.username || "Unknown";
        document.getElementById("coins").innerText = user.coins || 0;
        document.getElementById("referrals").innerText = user.referrals || 0;
        document.getElementById("status").innerText =
          user.referralStatus || "none";
        document.getElementById("referredBy").innerText =
          user.referredBy || "none";

        // Auto-confirm referral if pending
        if (user.referralStatus === "pending") {
          await fetch("/confirm-referral", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId }),
          });
          document.getElementById("status").innerText = "confirmed ‚úÖ";
        }
      }

      loadUser();
    </script>

    <style>
      body {
        background: #0e0e0e;
        color: #fff;
        font-family: "Poppins", sans-serif;
        text-align: center;
        margin: 0;
        padding: 40px;
      }
      .card {
        background: #1a1a1a;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 0 12px #333;
        max-width: 400px;
        margin: auto;
      }
      h2 {
        color: #00ffc3;
      }
      .stat {
        margin: 10px 0;
        font-size: 1.1em;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div class="card">
        <h2>üëã Welcome, <span id="username">Loading...</span></h2>
        <p class="stat">üí∞ Coins: <b id="coins">0</b></p>
        <p class="stat">üë• Referrals: <b id="referrals">0</b></p>
        <p class="stat">üìú Status: <b id="status">none</b></p>
        <p class="stat">üîó Referred By: <b id="referredBy">none</b></p>
      </div>
    </div>
  </body>
</html>