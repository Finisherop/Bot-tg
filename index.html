<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Referral Dashboard</title>
    <script type="module">
      // ==========================
      // üî• Firebase Configuration
      // ==========================
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyC_SO0ZnItNVoWif48MyMeznuLsA-jq52k",
        authDomain: "tgfjf-9f690.firebaseapp.com",
        databaseURL: "https://tgfjf-9f690-default-rtdb.firebaseio.com",
        projectId: "tgfjf-9f690",
        storageBucket: "tgfjf-9f690.appspot.com",
        messagingSenderId: "63734032391",
        appId: "1:63734032391:web:b35616ee989e6cb6d2d715",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ==========================
      // üåê URL Parameter Parsing
      // ==========================
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get("id") || "6779644494"; // default for testing
      console.log("[Dashboard] Checking user:", userId);

      const userRef = ref(db, `telegram_users/${userId}`);

      const userCard = document.getElementById("user-card");
      const loading = document.getElementById("loading");
      const notFound = document.getElementById("not-found");

      // ==========================
      // üì° Realtime Fetch
      // ==========================
      onValue(userRef, (snapshot) => {
        loading.style.display = "none";
        if (!snapshot.exists()) {
          notFound.style.display = "block";
          return;
        }

        const data = snapshot.val();
        userCard.style.display = "block";
        document.getElementById("username").textContent = data.username || "Unknown";
        animateCount("coins", data.coins || 0);
        animateCount("referrals", data.referrals || 0);
      });

      // ==========================
      // üî¢ Counter Animation
      // ==========================
      function animateCount(id, target) {
        const el = document.getElementById(id);
        let count = 0;
        const step = target / 40;
        const interval = setInterval(() => {
          count += step;
          if (count >= target) {
            clearInterval(interval);
            count = target;
          }
          el.textContent = Math.floor(count);
        }, 25);
      }
    </script>

    <style>
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: linear-gradient(135deg, #1d2671, #c33764);
        color: white;
      }

      .card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        width: 90%;
        max-width: 380px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
      }

      h2 {
        margin: 0 0 10px;
        font-weight: 600;
        font-size: 1.6rem;
      }

      .stats {
        display: flex;
        justify-content: space-around;
        margin-top: 25px;
      }

      .stat {
        text-align: center;
      }

      .stat h3 {
        font-size: 2rem;
        margin: 5px 0;
      }

      #loading {
        font-size: 1.2rem;
        animation: blink 1.2s infinite;
      }

      @keyframes blink {
        50% {
          opacity: 0.5;
        }
      }

      #not-found {
        display: none;
        color: #ffbaba;
        font-size: 1rem;
      }

      #user-card {
        display: none;
      }
    </style>
  </head>

  <body>
    <div id="loading">Loading user data...</div>

    <div id="not-found">‚ö†Ô∏è User not found in Firebase!</div>

    <div id="user-card" class="card">
      <h2 id="username">User</h2>
      <div class="stats">
        <div class="stat">
          <h3 id="coins">0</h3>
          <p>Coins</p>
        </div>
        <div class="stat">
          <h3 id="referrals">0</h3>
          <p>Referrals</p>
        </div>
      </div>
    </div>
  </body>
</html>