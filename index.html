<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Referral Dashboard</title>
    <script type="module">
      // =========================
      // 1Ô∏è‚É£ Firebase Setup
      // =========================
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
        get,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyC_SO0ZnItNVoWif48MyMeznuLsA-jq52k",
        authDomain: "tgfjf-5bbfe.firebaseapp.com",
        databaseURL: "https://tgfjf-5bbfe-default-rtdb.firebaseio.com",
        projectId: "tgfjf-5bbfe",
        storageBucket: "tgfjf-5bbfe.firebasestorage.app",
        messagingSenderId: "898327972915",
        appId: "1:898327972915:web:8450b0cfdf69134474e746",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // =========================
      // 2Ô∏è‚É£ Fetch User Data
      // =========================
      async function fetchUserData(userId) {
        try {
          const userRef = ref(db, `telegram_users/${userId}`);
          const snap = await get(userRef);
          if (snap.exists()) {
            const data = snap.val();
            renderDashboard(data);
          } else {
            document.querySelector("#content").innerHTML =
              "<p class='error'>User not found üòï</p>";
          }

          // üîÅ Realtime updates
          onValue(userRef, (snapshot) => {
            if (snapshot.exists()) {
              renderDashboard(snapshot.val());
            }
          });
        } catch (err) {
          console.error("Error fetching data:", err);
          document.querySelector("#content").innerHTML =
            "<p class='error'>Failed to fetch data ‚ùå</p>";
        }
      }

      // =========================
      // 3Ô∏è‚É£ Render UI
      // =========================
      function renderDashboard(data) {
        const { username, coins, referrals, referralStatus, referredBy } = data;
        document.querySelector("#content").innerHTML = `
          <div class="card">
            <h2>üëã Hey, ${username || "User"}</h2>
            <div class="stats">
              <div class="stat">
                <h3>${coins || 0}</h3>
                <p>Coins</p>
              </div>
              <div class="stat">
                <h3>${referrals || 0}</h3>
                <p>Referrals</p>
              </div>
            </div>
            <div class="details">
              <p><b>Status:</b> ${
                referralStatus || "‚Äî"
              }</p>
              <p><b>Referred By:</b> ${referredBy || "‚Äî"}</p>
            </div>
            <button id="shareBtn">üì§ Share Referral Link</button>
          </div>
        `;

        const shareBtn = document.getElementById("shareBtn");
        shareBtn.addEventListener("click", () => {
          const link = `https://t.me/Wiwiwjwjisjs_bot?start=ref${data.userId}`;
          navigator.clipboard.writeText(link);
          shareBtn.innerText = "‚úÖ Copied!";
          setTimeout(() => (shareBtn.innerText = "üì§ Share Referral Link"), 2000);
        });
      }

      // =========================
      // 4Ô∏è‚É£ Start Logic
      // =========================
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get("id") || "6779644494"; // Default for testing
      fetchUserData(userId);
    </script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap");
      body {
        font-family: "Poppins", sans-serif;
        background: radial-gradient(circle at top left, #0f2027, #203a43, #2c5364);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
      }
      .card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 25px;
        width: 320px;
        text-align: center;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      }
      h2 {
        font-size: 1.4rem;
        margin-bottom: 15px;
      }
      .stats {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
      }
      .stat h3 {
        font-size: 1.6rem;
        margin: 0;
      }
      .stat p {
        margin: 5px 0 0;
        color: #ddd;
      }
      .details {
        font-size: 0.9rem;
        text-align: left;
        margin-top: 15px;
      }
      button {
        margin-top: 20px;
        background: linear-gradient(135deg, #00c6ff, #0072ff);
        border: none;
        padding: 12px 20px;
        color: white;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.3s;
        width: 100%;
      }
      button:hover {
        transform: scale(1.05);
      }
      .error {
        color: #ff6b6b;
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div id="content">
      <p>Loading your dashboard...</p>
    </div>
  </body>
</html>
