<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* Custom animations and glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .coin-animation {
            animation: coinBounce 0.6s ease-in-out;
        }
        
        @keyframes coinBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-notification {
            animation: pulseNotification 0.5s ease-in-out;
        }
        
        @keyframes pulseNotification {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen text-white">
    
    <!-- Top Bar -->
    <div class="glass sticky top-0 z-50 p-4 flex justify-between items-center">
        <h1 id="app-title" class="text-xl font-bold">Loading...</h1>
        <div id="balance-display" class="flex items-center space-x-2">
            <span class="text-yellow-400">üí∞</span>
            <span id="user-balance" class="font-semibold">0</span>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main-content" class="p-4 pb-20">
        <!-- Content will be dynamically loaded here -->
    </div>

    <!-- Bottom Navigation -->
    <div id="bottom-nav" class="glass fixed bottom-0 left-0 right-0 p-4">
        <!-- Navigation will be dynamically loaded here -->
    </div>

    <!-- Notification Popup -->
    <div id="notification" class="fixed top-20 left-4 right-4 z-50 hidden">
        <div class="glass rounded-lg p-4 text-center pulse-notification">
            <p id="notification-text"></p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass rounded-lg p-6 text-center">
            <div class="loading-spinner w-8 h-8 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
            <p>Loading...</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "demo-api-key",
            authDomain: "demo-project.firebaseapp.com",
            databaseURL: "https://demo-project-default-rtdb.firebaseio.com/",
            projectId: "demo-project",
            storageBucket: "demo-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "demo-app-id"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global App State
        let currentUser = null;
        let isAdmin = false;
        let isUser = false;
        let currentPage = 'dashboard';

        // Utility Functions
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.className = `fixed top-20 left-4 right-4 z-50 fade-in`;
            
            if (type === 'success') {
                notification.firstElementChild.className += ' bg-green-500 bg-opacity-20 border-green-400';
            } else if (type === 'error') {
                notification.firstElementChild.className += ' bg-red-500 bg-opacity-20 border-red-400';
            } else {
                notification.firstElementChild.className += ' bg-blue-500 bg-opacity-20 border-blue-400';
            }
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        function generateReferralCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        // Initialize User
        async function initializeUser() {
            let userId = localStorage.getItem('telegram_user_id');
            
            if (!userId) {
                userId = generateUserId();
                localStorage.setItem('telegram_user_id', userId);
                
                // Create new user in database
                const newUser = {
                    id: userId,
                    username: `User${userId.substr(-4)}`,
                    totalEarn: 0,
                    totalWithdrawal: 0,
                    adsWatched: 0,
                    tasksCompleted: 0,
                    referralCode: generateReferralCode(),
                    referredBy: null,
                    createdAt: Date.now()
                };
                
                await database.ref('users/' + userId).set(newUser);
                currentUser = newUser;
            } else {
                // Load existing user
                const userSnapshot = await database.ref('users/' + userId).once('value');
                currentUser = userSnapshot.val() || {};
                currentUser.id = userId;
            }
            
            updateBalanceDisplay();
        }

        function updateBalanceDisplay() {
            if (currentUser) {
                document.getElementById('user-balance').textContent = currentUser.totalEarn || 0;
            }
        }

        // URL Parameter Detection
        function detectAppType() {
            const urlParams = new URLSearchParams(window.location.search);
            isUser = urlParams.get('user') === 'true';
            isAdmin = urlParams.get('admin') === 'true';
            
            if (isAdmin) {
                document.getElementById('app-title').textContent = 'Admin Panel';
                document.getElementById('balance-display').classList.add('hidden');
                loadAdminInterface();
            } else if (isUser) {
                document.getElementById('app-title').textContent = 'Telegram Mini App';
                loadUserInterface();
            } else {
                // Default to user interface
                isUser = true;
                document.getElementById('app-title').textContent = 'Telegram Mini App';
                loadUserInterface();
            }
        }

        // User Interface Functions
        async function loadUserInterface() {
            await initializeUser();
            loadUserDashboard();
            setupUserNavigation();
        }

        function loadUserDashboard() {
            const content = `
                <div class="space-y-6">
                    <!-- Dashboard Cards -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass rounded-xl p-4 text-center fade-in">
                            <div class="text-2xl mb-2">üí∞</div>
                            <div class="text-sm text-gray-300">Total Earn</div>
                            <div class="text-xl font-bold text-yellow-400" id="total-earn">${currentUser.totalEarn || 0}</div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center fade-in">
                            <div class="text-2xl mb-2">üè¶</div>
                            <div class="text-sm text-gray-300">Total Withdrawal</div>
                            <div class="text-xl font-bold text-green-400" id="total-withdrawal">${currentUser.totalWithdrawal || 0}</div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center fade-in">
                            <div class="text-2xl mb-2">üì∫</div>
                            <div class="text-sm text-gray-300">Ads Watched</div>
                            <div class="text-xl font-bold text-blue-400" id="ads-watched">${currentUser.adsWatched || 0}</div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center fade-in">
                            <div class="text-2xl mb-2">‚úÖ</div>
                            <div class="text-sm text-gray-300">Tasks Done</div>
                            <div class="text-xl font-bold text-purple-400" id="tasks-completed">${currentUser.tasksCompleted || 0}</div>
                        </div>
                    </div>

                    <!-- Quick Action Buttons -->
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="loadWatchAdsPage()" class="glass rounded-xl p-4 text-center hover:bg-white hover:bg-opacity-20 transition-all duration-300">
                            <div class="text-3xl mb-2">üì∫</div>
                            <div class="font-semibold">Watch Ads</div>
                        </button>
                        <button onclick="loadTasksPage()" class="glass rounded-xl p-4 text-center hover:bg-white hover:bg-opacity-20 transition-all duration-300">
                            <div class="text-3xl mb-2">üìã</div>
                            <div class="font-semibold">Tasks</div>
                        </button>
                        <button onclick="loadWithdrawPage()" class="glass rounded-xl p-4 text-center hover:bg-white hover:bg-opacity-20 transition-all duration-300">
                            <div class="text-3xl mb-2">üí∏</div>
                            <div class="font-semibold">Withdraw</div>
                        </button>
                        <button onclick="loadProfilePage()" class="glass rounded-xl p-4 text-center hover:bg-white hover:bg-opacity-20 transition-all duration-300">
                            <div class="text-3xl mb-2">üë§</div>
                            <div class="font-semibold">Profile</div>
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
            currentPage = 'dashboard';
            
            // Setup real-time listeners for user data
            setupUserDataListeners();
        }

        function setupUserDataListeners() {
            if (!currentUser) return;
            
            database.ref('users/' + currentUser.id).on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    currentUser = { ...currentUser, ...userData };
                    updateDashboardStats();
                    updateBalanceDisplay();
                }
            });
        }

        function updateDashboardStats() {
            const elements = {
                'total-earn': currentUser.totalEarn || 0,
                'total-withdrawal': currentUser.totalWithdrawal || 0,
                'ads-watched': currentUser.adsWatched || 0,
                'tasks-completed': currentUser.tasksCompleted || 0
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    element.classList.add('coin-animation');
                    setTimeout(() => element.classList.remove('coin-animation'), 600);
                }
            });
        }

        function setupUserNavigation() {
            const nav = `
                <div class="flex justify-around">
                    <button onclick="loadUserDashboard()" class="flex flex-col items-center space-y-1 ${currentPage === 'dashboard' ? 'text-yellow-400' : 'text-gray-400'}">
                        <span class="text-xl">üè†</span>
                        <span class="text-xs">Home</span>
                    </button>
                    <button onclick="loadTasksPage()" class="flex flex-col items-center space-y-1 ${currentPage === 'tasks' ? 'text-yellow-400' : 'text-gray-400'}">
                        <span class="text-xl">üìã</span>
                        <span class="text-xs">Tasks</span>
                    </button>
                    <button onclick="loadWithdrawPage()" class="flex flex-col items-center space-y-1 ${currentPage === 'withdraw' ? 'text-yellow-400' : 'text-gray-400'}">
                        <span class="text-xl">üí∏</span>
                        <span class="text-xs">Withdraw</span>
                    </button>
                    <button onclick="loadProfilePage()" class="flex flex-col items-center space-y-1 ${currentPage === 'profile' ? 'text-yellow-400' : 'text-gray-400'}">
                        <span class="text-xl">üë§</span>
                        <span class="text-xs">Profile</span>
                    </button>
                </div>
            `;
            
            document.getElementById('bottom-nav').innerHTML = nav;
        }

        // Watch Ads Page
        function loadWatchAdsPage() {
            const content = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold mb-4">Watch Ads & Earn</h2>
                        <p class="text-gray-300 mb-6">Watch ads to earn 10 coins each!</p>
                    </div>
                    
                    <div class="glass rounded-xl p-6 text-center">
                        <div class="text-6xl mb-4">üì∫</div>
                        <div id="ad-status" class="mb-6">
                            <button id="watch-ad-btn" onclick="watchAd()" class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 px-8 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105">
                                Watch Ad (+10 coins)
                            </button>
                        </div>
                    </div>
                    
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-semibold mb-3">Recent Ad Rewards</h3>
                        <div id="ad-history" class="space-y-2 text-sm text-gray-300">
                            <p>No ads watched yet</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
            currentPage = 'ads';
            setupUserNavigation();
            loadAdHistory();
        }

        async function watchAd() {
            const button = document.getElementById('watch-ad-btn');
            const status = document.getElementById('ad-status');
            
            button.disabled = true;
            button.textContent = 'Loading Ad...';
            
            // Simulate ad loading and playing
            setTimeout(() => {
                status.innerHTML = `
                    <div class="text-center">
                        <div class="loading-spinner w-12 h-12 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p>Playing Ad... Please wait</p>
                        <div class="mt-4 bg-gray-700 rounded-full h-2">
                            <div id="ad-progress" class="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full transition-all duration-100" style="width: 0%"></div>
                        </div>
                    </div>
                `;
                
                // Animate progress bar
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 2;
                    document.getElementById('ad-progress').style.width = progress + '%';
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        completeAdWatch();
                    }
                }, 100);
            }, 1000);
        }

        async function completeAdWatch() {
            // Update user data
            const newEarn = (currentUser.totalEarn || 0) + 10;
            const newAdsWatched = (currentUser.adsWatched || 0) + 1;
            
            await database.ref('users/' + currentUser.id).update({
                totalEarn: newEarn,
                adsWatched: newAdsWatched
            });
            
            // Add to ad history
            await database.ref('users/' + currentUser.id + '/adHistory').push({
                reward: 10,
                timestamp: Date.now()
            });
            
            // Show completion
            const status = document.getElementById('ad-status');
            status.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4 coin-animation">üéâ</div>
                    <p class="text-green-400 font-semibold mb-4">+10 Coins Earned!</p>
                    <button onclick="watchAd()" class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 px-8 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105">
                        Watch Another Ad
                    </button>
                </div>
            `;
            
            showNotification('üéâ You earned 10 coins!', 'success');
            loadAdHistory();
        }

        async function loadAdHistory() {
            const historyRef = database.ref('users/' + currentUser.id + '/adHistory');
            const snapshot = await historyRef.limitToLast(5).once('value');
            const history = snapshot.val();
            
            const historyDiv = document.getElementById('ad-history');
            if (!history) {
                historyDiv.innerHTML = '<p>No ads watched yet</p>';
                return;
            }
            
            const historyItems = Object.values(history).reverse().map(item => {
                const date = new Date(item.timestamp).toLocaleString();
                return `<div class="flex justify-between"><span>Ad Reward</span><span class="text-green-400">+${item.reward} coins</span></div>`;
            }).join('');
            
            historyDiv.innerHTML = historyItems;
        }

        // Tasks Page
        async function loadTasksPage() {
            const content = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold mb-4">Available Tasks</h2>
                        <p class="text-gray-300 mb-6">Complete tasks to earn rewards!</p>
                    </div>
                    
                    <div id="tasks-list" class="space-y-4">
                        <div class="text-center py-8">
                            <div class="loading-spinner w-8 h-8 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
                            <p>Loading tasks...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
            currentPage = 'tasks';
            setupUserNavigation();
            loadAvailableTasks();
        }

        async function loadAvailableTasks() {
            const tasksRef = database.ref('tasks');
            const snapshot = await tasksRef.once('value');
            const tasks = snapshot.val();
            
            const tasksList = document.getElementById('tasks-list');
            
            if (!tasks) {
                tasksList.innerHTML = `
                    <div class="glass rounded-xl p-6 text-center">
                        <div class="text-4xl mb-4">üìã</div>
                        <p class="text-gray-300">No tasks available at the moment</p>
                    </div>
                `;
                return;
            }
            
            const taskItems = Object.entries(tasks).map(([taskId, task]) => {
                const isCompleted = currentUser.completedTasks && currentUser.completedTasks[taskId];
                
                return `
                    <div class="glass rounded-xl p-4 fade-in">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-semibold text-lg">${task.title}</h3>
                            <span class="text-yellow-400 font-bold">+${task.reward}</span>
                        </div>
                        <p class="text-gray-300 text-sm mb-4">${task.description}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">Reward: ${task.reward} coins</span>
                            ${isCompleted ? 
                                '<span class="text-green-400 text-sm">‚úÖ Completed</span>' :
                                `<button onclick="startTask('${taskId}')" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-4 py-2 rounded-full text-sm font-semibold transition-all duration-300">
                                    Visit
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            tasksList.innerHTML = taskItems;
        }

        async function startTask(taskId) {
            const tasksRef = database.ref('tasks/' + taskId);
            const snapshot = await tasksRef.once('value');
            const task = snapshot.val();
            
            if (!task) return;
            
            // Show task timer modal
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="task-modal">
                    <div class="glass rounded-xl p-6 m-4 max-w-sm w-full text-center">
                        <h3 class="text-xl font-bold mb-4">${task.title}</h3>
                        <div class="text-6xl mb-4">‚è±Ô∏è</div>
                        <div id="task-timer" class="text-3xl font-bold mb-4">10</div>
                        <p class="text-gray-300 mb-4">Please wait while we verify your visit...</p>
                        <div class="bg-gray-700 rounded-full h-2 mb-4">
                            <div id="task-progress" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <button onclick="closeTaskModal()" class="text-gray-400 text-sm">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Start countdown
            let timeLeft = 10;
            const timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('task-timer').textContent = timeLeft;
                document.getElementById('task-progress').style.width = ((10 - timeLeft) / 10 * 100) + '%';
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showClaimButton(taskId, task);
                }
            }, 1000);
        }

        function showClaimButton(taskId, task) {
            const modal = document.getElementById('task-modal');
            modal.innerHTML = `
                <div class="glass rounded-xl p-6 m-4 max-w-sm w-full text-center">
                    <h3 class="text-xl font-bold mb-4">${task.title}</h3>
                    <div class="text-6xl mb-4">üéâ</div>
                    <p class="text-green-400 font-semibold mb-4">Task Completed!</p>
                    <p class="text-gray-300 mb-6">You can now claim your reward of ${task.reward} coins</p>
                    <button onclick="claimTaskReward('${taskId}', ${task.reward})" class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 mb-3 w-full">
                        Claim ${task.reward} Coins
                    </button>
                    <button onclick="closeTaskModal()" class="text-gray-400 text-sm">Close</button>
                </div>
            `;
        }

        async function claimTaskReward(taskId, reward) {
            // Update user data
            const newEarn = (currentUser.totalEarn || 0) + reward;
            const newTasksCompleted = (currentUser.tasksCompleted || 0) + 1;
            
            const updates = {
                totalEarn: newEarn,
                tasksCompleted: newTasksCompleted,
                [`completedTasks/${taskId}`]: {
                    reward: reward,
                    timestamp: Date.now()
                }
            };
            
            await database.ref('users/' + currentUser.id).update(updates);
            
            closeTaskModal();
            showNotification(`üéâ You earned ${reward} coins!`, 'success');
            loadTasksPage(); // Refresh tasks
        }

        function closeTaskModal() {
            const modal = document.getElementById('task-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Withdraw Page
        async function loadWithdrawPage() {
            const content = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold mb-4">Withdraw Earnings</h2>
                        <p class="text-gray-300 mb-6">Request withdrawal of your earned coins</p>
                    </div>
                    
                    <div class="glass rounded-xl p-6">
                        <div class="text-center mb-6">
                            <div class="text-4xl mb-2">üí∞</div>
                            <p class="text-gray-300">Available Balance</p>
                            <p class="text-3xl font-bold text-yellow-400">${currentUser.totalEarn || 0} coins</p>
                        </div>
                        
                        <div class="space-y-4">
                            <input type="number" id="withdraw-amount" placeholder="Enter amount to withdraw" 
                                   class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                            <button onclick="requestWithdrawal()" class="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 py-3 rounded-lg font-semibold transition-all duration-300">
                                Request Withdrawal
                            </button>
                        </div>
                    </div>
                    
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-semibold mb-4">Withdrawal History</h3>
                        <div id="withdrawal-history" class="space-y-3">
                            <div class="text-center py-4">
                                <div class="loading-spinner w-6 h-6 border-4 border-white border-t-transparent rounded-full mx-auto mb-2"></div>
                                <p class="text-sm text-gray-400">Loading history...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
            currentPage = 'withdraw';
            setupUserNavigation();
            loadWithdrawalHistory();
            setupWithdrawalListener();
        }

        async function requestWithdrawal() {
            const amountInput = document.getElementById('withdraw-amount');
            const amount = parseInt(amountInput.value);
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            
            if (amount > (currentUser.totalEarn || 0)) {
                showNotification('Insufficient balance', 'error');
                return;
            }
            
            // Create withdrawal request
            const withdrawalRequest = {
                userId: currentUser.id,
                username: currentUser.username,
                amount: amount,
                status: 'pending',
                timestamp: Date.now()
            };
            
            await database.ref('withdrawals').push(withdrawalRequest);
            
            amountInput.value = '';
            showNotification('Withdrawal request submitted!', 'success');
            loadWithdrawalHistory();
        }

        async function loadWithdrawalHistory() {
            const withdrawalsRef = database.ref('withdrawals');
            const snapshot = await withdrawalsRef.orderByChild('userId').equalTo(currentUser.id).once('value');
            const withdrawals = snapshot.val();
            
            const historyDiv = document.getElementById('withdrawal-history');
            
            if (!withdrawals) {
                historyDiv.innerHTML = '<p class="text-gray-400 text-center">No withdrawal requests yet</p>';
                return;
            }
            
            const withdrawalItems = Object.values(withdrawals).reverse().map(withdrawal => {
                const date = new Date(withdrawal.timestamp).toLocaleDateString();
                const statusColor = {
                    'pending': 'text-yellow-400',
                    'approved': 'text-green-400',
                    'rejected': 'text-red-400'
                }[withdrawal.status] || 'text-gray-400';
                
                const statusIcon = {
                    'pending': '‚è≥',
                    'approved': '‚úÖ',
                    'rejected': '‚ùå'
                }[withdrawal.status] || '‚è≥';
                
                return `
                    <div class="flex justify-between items-center p-3 bg-gray-800 bg-opacity-50 rounded-lg">
                        <div>
                            <p class="font-semibold">${withdrawal.amount} coins</p>
                            <p class="text-xs text-gray-400">${date}</p>
                        </div>
                        <div class="text-right">
                            <span class="${statusColor}">${statusIcon} ${withdrawal.status.charAt(0).toUpperCase() + withdrawal.status.slice(1)}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            historyDiv.innerHTML = withdrawalItems;
        }

        function setupWithdrawalListener() {
            const withdrawalsRef = database.ref('withdrawals');
            withdrawalsRef.orderByChild('userId').equalTo(currentUser.id).on('child_changed', (snapshot) => {
                const withdrawal = snapshot.val();
                if (withdrawal.status === 'approved') {
                    showNotification('‚úÖ Withdrawal approved!', 'success');
                } else if (withdrawal.status === 'rejected') {
                    showNotification('‚ùå Withdrawal rejected', 'error');
                }
                loadWithdrawalHistory();
            });
        }

        // Profile Page
        async function loadProfilePage() {
            const referralLink = `${window.location.origin}${window.location.pathname}?user=true&ref=${currentUser.referralCode}`;
            
            const content = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold mb-4">Profile</h2>
                    </div>
                    
                    <div class="glass rounded-xl p-6 text-center">
                        <div class="text-6xl mb-4">üë§</div>
                        <h3 class="text-xl font-bold mb-2">${currentUser.username}</h3>
                        <p class="text-gray-400 text-sm mb-4">ID: ${currentUser.id}</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <p class="text-2xl font-bold text-yellow-400">${currentUser.totalEarn || 0}</p>
                                <p class="text-xs text-gray-400">Total Earned</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-green-400">${currentUser.totalWithdrawal || 0}</p>
                                <p class="text-xs text-gray-400">Total Withdrawn</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-semibold mb-3">üîó Referral System</h3>
                        <p class="text-sm text-gray-300 mb-3">Share your referral link and earn 50 coins for each friend who joins!</p>
                        <div class="bg-gray-800 p-3 rounded-lg mb-3">
                            <p class="text-xs text-gray-400 mb-1">Your Referral Code:</p>
                            <p class="font-mono text-yellow-400">${currentUser.referralCode}</p>
                        </div>
                        <button onclick="copyReferralLink('${referralLink}')" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 py-2 rounded-lg text-sm font-semibold transition-all duration-300">
                            Copy Referral Link
                        </button>
                        <div class="mt-3 text-center">
                            <p class="text-sm text-gray-400">Referrals: <span class="text-green-400 font-semibold" id="referral-count">0</span></p>
                        </div>
                    </div>
                    
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-semibold mb-3">‚öôÔ∏è Settings</h3>
                        <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg text-sm font-semibold transition-all duration-300">
                            Logout
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
            currentPage = 'profile';
            setupUserNavigation();
            loadReferralCount();
        }

        async function loadReferralCount() {
            const usersRef = database.ref('users');
            const snapshot = await usersRef.orderByChild('referredBy').equalTo(currentUser.referralCode).once('value');
            const referrals = snapshot.val();
            
            const count = referrals ? Object.keys(referrals).length : 0;
            const countElement = document.getElementById('referral-count');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        function copyReferralLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                showNotification('Referral link copied!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Referral link copied!', 'success');
            });
        }

        function logout() {
            localStorage.removeItem('telegram_user_id');
            location.reload();
        }

        // Admin Interface Functions
        async function loadAdminInterface() {
            loadAdminDashboard();
            setupAdminNavigation();
        }

        async function loadAdminDashboard() {
            // Get admin statistics
            const usersSnapshot = await database.ref('users').once('value');
            const tasksSnapshot = await database.ref('tasks').once('value');
            const withdrawalsSnapshot = await database.ref('withdrawals').once('value');
            
            const users = usersSnapshot.val() || {};
            const tasks = tasksSnapshot.val() || {};
            const withdrawals = withdrawalsSnapshot.val() || {};
            
            const totalUsers = Object.keys(users).length;
            const totalTasks = Object.keys(tasks).length;
            const totalWithdrawals = Object.keys(withdrawals).length;
            const totalAdsWatched = Object.values(users).reduce((sum, user) => sum + (user.adsWatched || 0), 0);
            
            const content = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold mb-4">Admin Dashboard</h2>
                        <p class="text-gray-300 mb-6">Manage your Telegram Mini App</p>
                    </div>
                    
                    <!-- Admin Stats -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass rounded-xl p-4 text-center fade-in">
                            <div class="text-2xl mb-2">üë•</div>
                            <div class="text-sm text-gray-300">Total Users</div>
                            <div class="text-xl font-bold text-blue-400">${totalUsers}</div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center fade-in">
                            <div class="text-2xl mb-2">üìã</div>
                            <div class="text-sm text-gray-300">Total Tasks</div>
                            <div class="text-xl font-bold text-purple-400">${totalTasks}</div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center fade-in">
                            <div class="text-2xl mb-2">üí∏</div>
                            <div class="text-sm text-gray-300">Withdrawals</div>
                            <div class="text-xl font-bold text-green-400">${totalWithdrawals}</div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center fade-in">
                            <div class="text-2xl mb-2">üì∫</div>
                            <div class="text-sm text-gray-300">Ads Watched</div>
                            <div class="text-xl font-bold text-yellow-400">${totalAdsWatched}</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-semibold mb-4">Quick Actions</h3>
                        <div class="space-y-3">
                            <button onclick="showAddTaskModal()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 py-3 rounded-lg font-semibold transition-all duration-300">
                                ‚ûï Add New Task
                            </button>
                            <button onclick="loadAdminTasksPage()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 py-3 rounded-lg font-semibold transition-all duration-300">
                                üìã Manage Tasks
                            </button>
                            <button onclick="loadAdminWithdrawalsPage()" class="w-full bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 py-3 rounded-lg font-semibold transition-all duration-300">
                                üí∏ Manage Withdrawals
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
            currentPage = 'admin-dashboard';
        }

        function setupAdminNavigation() {
            const nav = `
                <div class="flex justify-around">
                    <button onclick="loadAdminDashboard()" class="flex flex-col items-center space-y-1 ${currentPage === 'admin-dashboard' ? 'text-yellow-400' : 'text-gray-400'}">
                        <span class="text-xl">üìä</span>
                        <span class="text-xs">Dashboard</span>
                    </button>
                    <button onclick="loadAdminTasksPage()" class="flex flex-col items-center space-y-1 ${currentPage === 'admin-tasks' ? 'text-yellow-400' : 'text-gray-400'}">
                        <span class="text-xl">üìã</span>
                        <span class="text-xs">Tasks</span>
                    </button>
                    <button onclick="loadAdminWithdrawalsPage()" class="flex flex-col items-center space-y-1 ${currentPage === 'admin-withdrawals' ? 'text-yellow-400' : 'text-gray-400'}">
                        <span class="text-xl">üí∏</span>
                        <span class="text-xs">Withdrawals</span>
                    </button>
                    <button onclick="loadAdminSettingsPage()" class="flex flex-col items-center space-y-1 ${currentPage === 'admin-settings' ? 'text-yellow-400' : 'text-gray-400'}">
                        <span class="text-xl">‚öôÔ∏è</span>
                        <span class="text-xs">Settings</span>
                    </button>
                </div>
            `;
            
            document.getElementById('bottom-nav').innerHTML = nav;
        }

        // Admin Task Management
        function showAddTaskModal() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="add-task-modal">
                    <div class="glass rounded-xl p-6 m-4 max-w-md w-full">
                        <h3 class="text-xl font-bold mb-4">Add New Task</h3>
                        <div class="space-y-4">
                            <input type="text" id="task-title" placeholder="Task Title" 
                                   class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                            <textarea id="task-description" placeholder="Task Description" rows="3"
                                      class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none resize-none"></textarea>
                            <input type="number" id="task-reward" placeholder="Reward (coins)" 
                                   class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                            <input type="url" id="task-link" placeholder="Task Link (optional)" 
                                   class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button onclick="addNewTask()" class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 py-3 rounded-lg font-semibold transition-all duration-300">
                                Add Task
                            </button>
                            <button onclick="closeAddTaskModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 py-3 rounded-lg font-semibold transition-all duration-300">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        async function addNewTask() {
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const reward = parseInt(document.getElementById('task-reward').value);
            const link = document.getElementById('task-link').value.trim();
            
            if (!title || !description || !reward) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const newTask = {
                title: title,
                description: description,
                reward: reward,
                link: link || '',
                createdAt: Date.now(),
                active: true
            };
            
            await database.ref('tasks').push(newTask);
            
            closeAddTaskModal();
            showNotification('Task added successfully!', 'success');
            
            if (currentPage === 'admin-tasks') {
                loadAdminTasksPage();
            }
        }

        function closeAddTaskModal() {
            const modal = document.getElementById('add-task-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function loadAdminTasksPage() {
            const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Manage Tasks</h2>
                        <button onclick="showAddTaskModal()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-300">
                            ‚ûï Add Task
                        </button>
                    </div>
                    
                    <div id="admin-tasks-list" class="space-y-4">
                        <div class="text-center py-8">
                            <div class="loading-spinner w-8 h-8 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
                            <p>Loading tasks...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
            currentPage = 'admin-tasks';
            setupAdminNavigation();
            loadAdminTasksList();
        }

        async function loadAdminTasksList() {
            const tasksRef = database.ref('tasks');
            const snapshot = await tasksRef.once('value');
            const tasks = snapshot.val();
            
            const tasksList = document.getElementById('admin-tasks-list');
            
            if (!tasks) {
                tasksList.innerHTML = `
                    <div class="glass rounded-xl p-6 text-center">
                        <div class="text-4xl mb-4">üìã</div>
                        <p class="text-gray-300">No tasks created yet</p>
                    </div>
                `;
                return;
            }
            
            const taskItems = Object.entries(tasks).map(([taskId, task]) => {
                return `
                    <div class="glass rounded-xl p-4 fade-in">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-semibold text-lg">${task.title}</h3>
                            <div class="flex space-x-2">
                                <button onclick="editTask('${taskId}')" class="text-blue-400 hover:text-blue-300 text-sm">‚úèÔ∏è Edit</button>
                                <button onclick="deleteTask('${taskId}')" class="text-red-400 hover:text-red-300 text-sm">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <p class="text-gray-300 text-sm mb-3">${task.description}</p>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-yellow-400 font-semibold">Reward: ${task.reward} coins</span>
                            <span class="text-gray-400">Created: ${new Date(task.createdAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            tasksList.innerHTML = taskItems;
        }

        async function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                await database.ref('tasks/' + taskId).remove();
                showNotification('Task deleted successfully!', 'success');
                loadAdminTasksList();
            }
        }

        // Admin Withdrawals Management
        async function loadAdminWithdrawalsPage() {
            const content = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold mb-4">Manage Withdrawals</h2>
                        <p class="text-gray-300 mb-6">Review and process withdrawal requests</p>
                    </div>
                    
                    <div id="admin-withdrawals-list" class="space-y-4">
                        <div class="text-center py-8">
                            <div class="loading-spinner w-8 h-8 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
                            <p>Loading withdrawals...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
            currentPage = 'admin-withdrawals';
            setupAdminNavigation();
            loadAdminWithdrawalsList();
        }

        async function loadAdminWithdrawalsList() {
            const withdrawalsRef = database.ref('withdrawals');
            const snapshot = await withdrawalsRef.orderByChild('timestamp').once('value');
            const withdrawals = snapshot.val();
            
            const withdrawalsList = document.getElementById('admin-withdrawals-list');
            
            if (!withdrawals) {
                withdrawalsList.innerHTML = `
                    <div class="glass rounded-xl p-6 text-center">
                        <div class="text-4xl mb-4">üí∏</div>
                        <p class="text-gray-300">No withdrawal requests yet</p>
                    </div>
                `;
                return;
            }
            
            const withdrawalItems = Object.entries(withdrawals).reverse().map(([withdrawalId, withdrawal]) => {
                const statusColor = {
                    'pending': 'text-yellow-400',
                    'approved': 'text-green-400',
                    'rejected': 'text-red-400'
                }[withdrawal.status] || 'text-gray-400';
                
                const date = new Date(withdrawal.timestamp).toLocaleString();
                
                return `
                    <div class="glass rounded-xl p-4 fade-in">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-semibold">${withdrawal.username}</h3>
                                <p class="text-sm text-gray-400">ID: ${withdrawal.userId}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-yellow-400">${withdrawal.amount} coins</p>
                                <p class="text-sm ${statusColor}">${withdrawal.status.toUpperCase()}</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mb-3">${date}</p>
                        
                        ${withdrawal.status === 'pending' ? `
                            <div class="flex space-x-2">
                                <button onclick="approveWithdrawal('${withdrawalId}')" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg text-sm font-semibold transition-all duration-300">
                                    ‚úÖ Approve
                                </button>
                                <button onclick="rejectWithdrawal('${withdrawalId}')" class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded-lg text-sm font-semibold transition-all duration-300">
                                    ‚ùå Reject
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            withdrawalsList.innerHTML = withdrawalItems;
        }

        async function approveWithdrawal(withdrawalId) {
            await database.ref('withdrawals/' + withdrawalId).update({
                status: 'approved',
                processedAt: Date.now()
            });
            
            showNotification('Withdrawal approved!', 'success');
            loadAdminWithdrawalsList();
        }

        async function rejectWithdrawal(withdrawalId) {
            await database.ref('withdrawals/' + withdrawalId).update({
                status: 'rejected',
                processedAt: Date.now()
            });
            
            showNotification('Withdrawal rejected!', 'success');
            loadAdminWithdrawalsList();
        }

        // Admin Settings Page
        function loadAdminSettingsPage() {
            const content = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold mb-4">Admin Settings</h2>
                    </div>
                    
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-semibold mb-4">üîß Admin Tools</h3>
                        <div class="space-y-3">
                            <button onclick="showBroadcastModal()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 py-3 rounded-lg font-semibold transition-all duration-300">
                                üì¢ Broadcast Message
                            </button>
                            <button onclick="showUserBalanceModal()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 py-3 rounded-lg font-semibold transition-all duration-300">
                                üí∞ Adjust User Balance
                            </button>
                            <button onclick="viewAdminLogs()" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 py-3 rounded-lg font-semibold transition-all duration-300">
                                üìã View Admin Logs
                            </button>
                        </div>
                    </div>
                    
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-semibold mb-4">üìä Statistics</h3>
                        <div id="admin-stats" class="space-y-3 text-sm">
                            <div class="text-center py-4">
                                <div class="loading-spinner w-6 h-6 border-4 border-white border-t-transparent rounded-full mx-auto mb-2"></div>
                                <p class="text-gray-400">Loading statistics...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
            currentPage = 'admin-settings';
            setupAdminNavigation();
            loadAdminStats();
        }

        async function loadAdminStats() {
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val() || {};
            
            const totalEarnings = Object.values(users).reduce((sum, user) => sum + (user.totalEarn || 0), 0);
            const totalWithdrawals = Object.values(users).reduce((sum, user) => sum + (user.totalWithdrawal || 0), 0);
            const activeUsers = Object.values(users).filter(user => user.adsWatched > 0 || user.tasksCompleted > 0).length;
            
            const statsDiv = document.getElementById('admin-stats');
            statsDiv.innerHTML = `
                <div class="flex justify-between"><span>Total Earnings:</span><span class="text-yellow-400">${totalEarnings} coins</span></div>
                <div class="flex justify-between"><span>Total Withdrawals:</span><span class="text-green-400">${totalWithdrawals} coins</span></div>
                <div class="flex justify-between"><span>Active Users:</span><span class="text-blue-400">${activeUsers}</span></div>
                <div class="flex justify-between"><span>Total Users:</span><span class="text-purple-400">${Object.keys(users).length}</span></div>
            `;
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            // Check for referral
            const urlParams = new URLSearchParams(window.location.search);
            const referralCode = urlParams.get('ref');
            
            if (referralCode) {
                localStorage.setItem('referral_code', referralCode);
            }
            
            detectAppType();
            hideLoading();
        });

        // Handle referral rewards
        async function processReferral() {
            const referralCode = localStorage.getItem('referral_code');
            if (!referralCode || !currentUser) return;
            
            // Check if user already has a referrer
            if (currentUser.referredBy) return;
            
            // Find the referrer
            const usersRef = database.ref('users');
            const snapshot = await usersRef.orderByChild('referralCode').equalTo(referralCode).once('value');
            const referrer = snapshot.val();
            
            if (referrer) {
                const referrerId = Object.keys(referrer)[0];
                const referrerData = referrer[referrerId];
                
                // Update current user with referrer info
                await database.ref('users/' + currentUser.id).update({
                    referredBy: referralCode
                });
                
                // Give referral reward to referrer
                const newEarn = (referrerData.totalEarn || 0) + 50;
                await database.ref('users/' + referrerId).update({
                    totalEarn: newEarn
                });
                
                localStorage.removeItem('referral_code');
                showNotification('Welcome! Your referrer earned 50 coins!', 'success');
            }
        }
    </script>
</body>
</html>
